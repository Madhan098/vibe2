<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Editor - CodeMind</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='icons/icon-192x192.png') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='icons/icon-192x192.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/editor.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
    <script src="{{ url_for('static', filename='js/api.js') }}"></script>
    <script src="{{ url_for('static', filename='js/auth.js') }}"></script>
</head>
<body>
    <script>
        // Require authentication to access this page
        window.addEventListener('DOMContentLoaded', async () => {
            // Check if user is authenticated
            const token = localStorage.getItem('token');
            if (!token) {
                // Not authenticated, redirect to login
                window.location.href = '{{ url_for("login_page") }}';
                return;
            }
            
            // Verify token is valid
            try {
                const userData = await getCurrentUser();
                if (!userData.success || !userData.user) {
                    // Token is invalid, redirect to login
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    window.location.href = '{{ url_for("login_page") }}';
                    return;
                }
                
                // User is authenticated, show user info
                const userInfo = document.getElementById('user-info');
                const logoutBtn = document.getElementById('logout-btn');
                if (userInfo) {
                    userInfo.textContent = `üë§ ${userData.user.name || userData.user.email}`;
                    userInfo.style.display = 'inline';
                }
                if (logoutBtn) {
                    logoutBtn.style.display = 'inline-block';
                    logoutBtn.addEventListener('click', async () => {
                        await logout();
                        window.location.href = '{{ url_for("login_page") }}';
                    });
                }
            } catch (error) {
                console.error('Error loading user info:', error);
                // Error verifying token, redirect to login
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = '{{ url_for("login_page") }}';
            }
        });
    </script>
    <div class="container">
        <nav class="navbar">
            <div class="nav-content">
                <div class="logo">
                    <span class="logo-icon">üß†</span>
                    <span class="logo-text">CodeMind</span>
                </div>
                <button class="mobile-menu-toggle" id="mobile-menu-toggle" aria-label="Toggle menu">
                    ‚ò∞
                </button>
                <div class="nav-links" id="nav-links">
                    <a href="{{ url_for('index') }}" class="nav-link">Home</a>
                    <a href="{{ url_for('upload') }}" class="nav-link">Upload</a>
                    <span id="user-info" style="display: none; margin-left: 20px; color: var(--text-secondary);"></span>
                    <button id="logout-btn" class="btn btn-small" style="display: none; margin-left: 10px;">Logout</button>
                </div>
            </div>
        </nav>

        <main class="editor-page">
            <div class="editor-container">
                <!-- VS Code-like Sidebar -->
                <div class="vscode-sidebar" id="vscode-sidebar">
                    <div class="sidebar-header">
                        <h3>Explorer</h3>
                        <button class="btn-icon" id="toggle-sidebar-btn" title="Toggle Sidebar">‚óÄ</button>
                    </div>
                    <div class="sidebar-content">
                        <div class="sidebar-section">
                            <div class="sidebar-section-header">
                                <span>üìÅ Files</span>
                                <button class="btn-icon-small" id="new-folder-btn" title="New Folder">üìÅ</button>
                                <button class="btn-icon-small" id="new-file-sidebar-btn" title="New File">üìÑ</button>
                            </div>
                            <div class="file-tree" id="file-tree">
                                <div class="file-tree-item active" data-file="main.py">
                                    <span class="file-icon">üêç</span>
                                    <span class="file-name">main.py</span>
                                </div>
                            </div>
                        </div>
                        <div class="sidebar-section">
                            <div class="sidebar-section-header">
                                <span>üîÄ Git</span>
                                <span id="github-connection-status" class="connection-status" style="display: none;">üîó</span>
                            </div>
                            <div id="github-not-connected" class="github-not-connected" style="display: none;">
                                <button class="sidebar-btn btn-connect-github" id="connect-github-btn" style="background: #10b981; color: white; margin-bottom: 8px;">
                                    üîó Connect GitHub
                                </button>
                                <small style="color: var(--text-secondary); font-size: 11px; display: block; text-align: center;">
                                    Connect to use Git features
                                </small>
                            </div>
                            <div id="github-connected" class="git-actions" style="display: none;">
                                <button class="sidebar-btn" id="git-status-btn">üìä Status</button>
                                <button class="sidebar-btn" id="git-commit-btn">üíæ Commit</button>
                                <button class="sidebar-btn" id="git-push-btn">‚¨ÜÔ∏è Push</button>
                                <button class="sidebar-btn" id="git-pull-btn">‚¨áÔ∏è Pull</button>
                                <button class="sidebar-btn" id="git-disconnect-btn" style="background: rgba(239, 68, 68, 0.2); color: #ef4444; margin-top: 8px;">
                                    üîå Disconnect
                                </button>
                            </div>
                        </div>
                        <div class="sidebar-section">
                            <div class="sidebar-section-header">
                                <span>‚ñ∂Ô∏è Run</span>
                            </div>
                            <div class="run-actions">
                                <button class="sidebar-btn" id="run-code-sidebar-btn">‚ñ∂Ô∏è Run Code</button>
                                <button class="sidebar-btn" id="debug-code-sidebar-btn">üêõ Debug</button>
                                <button class="sidebar-btn" id="format-code-sidebar-btn">‚ú® Format</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="editor-panel">
                    <!-- VS Code Style Top Menu Bar -->
                    <div class="vscode-menu-bar">
                        <div class="menu-group">
                            <div class="menu-item" id="file-menu">
                                <span>File</span>
                                <div class="menu-dropdown" id="file-dropdown">
                                    <div class="dropdown-item" id="new-file">üìÑ New File</div>
                                    <div class="dropdown-item" id="open-file">üìÇ Open File</div>
                                    <div class="dropdown-divider"></div>
                                    <div class="dropdown-item" id="save-file">üíæ Save</div>
                                    <div class="dropdown-item" id="save-as-file">üíæ Save As...</div>
                                    <div class="dropdown-divider"></div>
                                    <div class="dropdown-item" id="download-file">‚¨áÔ∏è Download</div>
                                </div>
                            </div>
                            <div class="menu-item" id="edit-menu">
                                <span>Edit</span>
                                <div class="menu-dropdown" id="edit-dropdown">
                                    <div class="dropdown-item" id="undo-action">‚Ü∂ Undo</div>
                                    <div class="dropdown-item" id="redo-action">‚Ü∑ Redo</div>
                                    <div class="dropdown-divider"></div>
                                    <div class="dropdown-item" id="cut-action">‚úÇÔ∏è Cut</div>
                                    <div class="dropdown-item" id="copy-action">üìã Copy</div>
                                    <div class="dropdown-item" id="paste-action">üìÑ Paste</div>
                                    <div class="dropdown-divider"></div>
                                    <div class="dropdown-item" id="find-action">üîç Find</div>
                                    <div class="dropdown-item" id="replace-action">üîÑ Replace</div>
                                    <div class="dropdown-item" id="find-all-action">üîç Find All</div>
                                </div>
                            </div>
                            <div class="menu-item" id="view-menu">
                                <span>View</span>
                                <div class="menu-dropdown" id="view-dropdown">
                                    <div class="dropdown-item" id="zoom-in">üîç Zoom In</div>
                                    <div class="dropdown-item" id="zoom-out">üîç Zoom Out</div>
                                    <div class="dropdown-item" id="reset-zoom">üîç Reset Zoom</div>
                                    <div class="dropdown-divider"></div>
                                    <div class="dropdown-item" id="toggle-theme">üåì Toggle Theme</div>
                                    <div class="dropdown-item" id="toggle-minimap">üó∫Ô∏è Toggle Minimap</div>
                                    <div class="dropdown-item" id="toggle-word-wrap">üìù Toggle Word Wrap</div>
                                </div>
                            </div>
                            <div class="menu-item" id="run-menu">
                                <span>Run</span>
                                <div class="menu-dropdown" id="run-dropdown">
                                    <div class="dropdown-item" id="run-code">‚ñ∂Ô∏è Run Code</div>
                                    <div class="dropdown-item" id="debug-code">üêõ Debug</div>
                                    <div class="dropdown-item" id="format-code">‚ú® Format Document</div>
                                </div>
                            </div>
                            <div class="menu-item" id="terminal-menu">
                                <span>Terminal</span>
                                <div class="menu-dropdown" id="terminal-dropdown">
                                    <div class="dropdown-item" id="new-terminal">‚ûï New Terminal</div>
                                    <div class="dropdown-item" id="toggle-terminal">üñ•Ô∏è Toggle Terminal</div>
                                </div>
                            </div>
                        </div>
                        <div class="menu-group-right">
                            <select id="language-selector" class="language-selector">
                                <option value="python">Python</option>
                                <option value="javascript">JavaScript</option>
                                <option value="typescript">TypeScript</option>
                                <option value="java">Java</option>
                                <option value="html">HTML</option>
                                <option value="css">CSS</option>
                                <option value="json">JSON</option>
                                <option value="markdown">Markdown</option>
                            </select>
                            <button class="btn-icon" id="settings-btn" title="Settings">‚öôÔ∏è</button>
                        </div>
                    </div>
                    
                    <div class="panel-header">
                        <h3>Code Editor</h3>
                        <div class="header-controls">
                        <button class="btn btn-small" id="clear-btn">Clear</button>
                        </div>
                    </div>
                    <div id="monaco-editor" class="monaco-container"></div>
                    
                    <!-- Terminal Panel (hidden by default) -->
                    <div id="terminal-panel" class="terminal-panel" style="display: none;">
                        <div class="terminal-header">
                            <span>Terminal</span>
                            <button class="btn-icon" id="close-terminal-btn">‚úï</button>
                        </div>
                        <div id="terminal-content" class="terminal-content"></div>
                    </div>
                </div>

                <div class="ai-panel">
                    <div class="panel-header">
                        <h3>AI Assistant</h3>
                        <div class="header-controls" style="display: flex; gap: 10px; align-items: center;">
                            <label class="beginner-mode-toggle" style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.9rem;">
                                <input type="checkbox" id="beginner-mode-toggle" style="cursor: pointer;" />
                                <span>üéì Beginner Mode</span>
                            </label>
                        </div>
                        <div class="status-indicator" id="status-indicator">
                            <span class="status-dot"></span>
                            <span id="status-text">Ready</span>
                        </div>
                    </div>
                    <div class="ai-content">
                        <!-- Code Generation Input -->
                        <div class="ai-input-section">
                            <label for="code-request-input">Ask AI to generate code:</label>
                            
                            <div class="input-group">
                                <input 
                                    type="text" 
                                    id="code-request-input" 
                                    placeholder="e.g., Create a function to calculate factorial, Build a REST API endpoint..."
                                    class="input-field"
                                >
                                <button class="btn btn-primary" id="generate-code-btn">Generate</button>
                            </div>
                            
                            <!-- Custom Tech Stack Button and Input -->
                            <div class="tech-stack-section" style="margin-top: 10px;">
                                <button class="btn btn-secondary" id="custom-stack-btn" style="width: 100%; margin-bottom: 10px;">
                                    üîß Custom Stack
                                </button>
                                <div id="tech-stack-input-container" style="display: none;">
                                    <input 
                                        type="text" 
                                        id="tech-stack-input" 
                                        placeholder="Enter your tech stack (e.g., React + Node.js + MongoDB)"
                                        class="input-field"
                                        style="width: 100%; margin-bottom: 5px;"
                                    >
                                    <small class="hint-text">Optional: Specify your tech stack for better code generation</small>
                                </div>
                            </div>
                            
                            <small class="hint-text">AI will write code matching your coding style and patterns, and fix errors found by the recommender</small>
                        </div>

                        <!-- Accept/Reject Dialog -->
                        <div id="accept-reject-dialog" class="accept-reject-dialog" style="display: none;">
                            <div class="dialog-header">
                                <h3>üéØ Code Generation Complete</h3>
                                <p id="dialog-explanation" class="dialog-explanation"></p>
                            </div>
                            <div class="dialog-content">
                                <div id="dialog-files-list" class="dialog-files-list"></div>
                            </div>
                            <div class="dialog-actions">
                                <button class="btn btn-success" id="accept-all-code-btn" style="background: #10b981; color: white; padding: 12px 24px; font-size: 16px; font-weight: 600;">
                                    ‚úÖ Accept & Apply All
                                </button>
                                <button class="btn btn-danger" id="reject-all-code-btn" style="background: #ef4444; color: white; padding: 12px 24px; font-size: 16px; font-weight: 600;">
                                    ‚ùå Reject All
                                </button>
                            </div>
                        </div>
                        
                        <!-- Generated Code Display -->
                        <div id="generated-code" class="generated-code-section" style="display: none;">
                            <div class="generated-header">
                                <h4>Generated Code</h4>
                                <button class="btn btn-small btn-secondary" id="close-generated-btn">‚úï</button>
                            </div>
                            <div class="generated-explanation" id="generated-explanation"></div>
                            
                            <!-- Single File Display -->
                            <div id="single-file-display">
                                <div class="generated-code-content">
                                    <pre><code id="generated-code-content"></code></pre>
                                </div>
                                <div class="generated-actions">
                                    <button class="btn btn-primary" id="insert-code-btn">üìù Insert into Editor</button>
                                    <button class="btn btn-secondary" id="copy-code-btn">üìã Copy</button>
                                </div>
                            </div>
                            
                            <!-- Multi-File Display -->
                            <div id="multi-file-display" style="display: none;">
                                <div class="multi-file-list" id="multi-file-list"></div>
                                <div class="generated-actions">
                                    <button class="btn btn-success" id="accept-all-btn" style="background: #10b981; color: white;">‚úÖ Accept All</button>
                                    <button class="btn btn-danger" id="reject-all-btn" style="background: #ef4444; color: white;">‚ùå Reject All</button>
                                </div>
                            </div>
                        </div>

                        <!-- Code Suggestion (existing) -->
                        <div id="no-suggestion" class="ai-placeholder">
                            <div class="placeholder-icon">üí°</div>
                            <p>Start typing code...</p>
                            <p class="placeholder-hint">AI will analyze your code and suggest improvements matching your style</p>
                            <p class="beginner-hint" id="beginner-hint" style="display: none; margin-top: 15px; padding: 10px; background: rgba(99, 102, 241, 0.1); border-radius: 8px; color: var(--primary-color); font-size: 0.9rem;">
                                üéì <strong>Beginner Mode:</strong> Write your first function and choose from multiple style options!
                            </p>
                        </div>
                        
                        <!-- Beginner Mode: Multiple Style Options -->
                        <div id="beginner-options" style="display: none; margin-top: 20px;">
                            <h4 style="margin-bottom: 15px; color: var(--text-primary); font-size: 1.1rem;">Choose the style that feels right to you:</h4>
                            <div id="style-options-list" style="display: flex; flex-direction: column; gap: 12px;"></div>
                            <div class="beginner-actions" style="margin-top: 15px; display: flex; gap: 10px;">
                                <button class="btn btn-secondary" id="skip-style-btn">Skip</button>
                            </div>
                        </div>
                        <!-- Side-by-Side Code Comparison -->
                        <div id="suggestion-panel" class="suggestion-panel" style="display: none;">
                            <div class="suggestion-header">
                                <h3>üí° AI Suggestion</h3>
                                <div class="confidence-badge">
                                    <span>Confidence:</span>
                                    <span id="confidence-value">85%</span>
                                </div>
                                <button class="btn btn-small btn-icon" id="close-suggestion-btn">‚úï</button>
                            </div>

                            <!-- Side-by-Side Comparison -->
                            <div class="code-comparison">
                                <div class="comparison-column">
                                    <h4>Your Code</h4>
                                    <pre><code id="original-code" class="language-python"></code></pre>
                                </div>
                                <div class="comparison-arrow">‚Üí</div>
                                <div class="comparison-column highlight">
                                    <h4>Improved (Matching YOUR Style)</h4>
                                    <pre><code id="improved-code" class="language-python"></code></pre>
                                </div>
                            </div>

                            <!-- What Changed -->
                            <div class="changes-section">
                                <h4>‚ú® What Changed:</h4>
                                <ul id="changes-list">
                                    <!-- Dynamically populated -->
                                </ul>
                            </div>

                            <!-- Why It Matches Your Style -->
                            <div class="style-match-section">
                                <h4>üéØ Why This Matches YOUR Style:</h4>
                                <div id="style-explanation"></div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="action-buttons">
                                <button class="btn-accept" id="accept-suggestion-btn">
                                    ‚úì Accept & Learn
                                </button>
                                <button class="btn-reject" id="reject-suggestion-btn">
                                    ‚úó Keep Mine
                                </button>
                                <button class="btn-explain" id="explain-more-btn">
                                    ? Explain More
                                </button>
                            </div>
                        </div>
                        <div id="loading-suggestion" class="ai-loading" style="display: none;">
                            <div class="spinner-small"></div>
                            <p id="loading-text">Analyzing your code...</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <h3 id="loading-text">Analyzing your code...</h3>
            <p id="loading-subtitle">Extracting your coding DNA</p>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- GitHub Connection Modal -->
    <div id="github-connection-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üîó Connect GitHub Account</h3>
                <button class="btn-icon" id="close-github-modal-btn">‚úï</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    Connect your GitHub account to enable Git operations (Commit, Push, Pull).
                </p>
                <div class="input-group" style="margin-bottom: 15px;">
                    <label for="github-token-input">GitHub Personal Access Token:</label>
                    <input 
                        type="password" 
                        id="github-token-input" 
                        placeholder="ghp_xxxxxxxxxxxxxxxxxxxx"
                        class="input-field"
                        style="width: 100%;"
                    >
                    <small style="color: var(--text-secondary); font-size: 12px; display: block; margin-top: 5px;">
                        Create a token at: <a href="https://github.com/settings/tokens" target="_blank" style="color: #8b5cf6;">github.com/settings/tokens</a>
                    </small>
                </div>
                <div class="input-group" style="margin-bottom: 20px;">
                    <label for="github-username-input">GitHub Username (optional):</label>
                    <input 
                        type="text" 
                        id="github-username-input" 
                        placeholder="Your GitHub username"
                        class="input-field"
                        style="width: 100%;"
                    >
                </div>
                <div class="modal-actions">
                    <button class="btn btn-primary" id="connect-github-submit-btn" style="width: 100%;">
                        üîó Connect GitHub
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script src="{{ url_for('static', filename='js/editor.js') }}"></script>
    <script src="{{ url_for('static', filename='js/mobile-menu.js') }}"></script>
</body>
</html>
